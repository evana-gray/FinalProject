---
title: "EDA"
format: html
editor: visual
---

 Diabetes is an economically costly disease that can severely disrupt quality of life. The purpose of this project is to identify demographic and behavioral risk factors that could be used to predict diabetes. Such methods could inform clinical practice by alerting clinicians which patients could be at risk. This project's data was sourced from the CDC's 2015 Behavioral Risk Factor Surveillance System (BRFSS) and was accessed from www.kaggle.com. 
 
 The first task will be to read in and explore the dataset. This includes looking for missing values and creating data tables and plots to investigate the relationship between variables. This will help to determine what data elements are potential risk factors that we should include in our prediction models. 

```{r}
library(tidyverse)
library(psych)
library(ggplot2)
library(future)

```

# Read Data
```{r}
diabetes <- read_csv("diabetes_binary_health_indicators_BRFSS2015.csv")

#convert col names to lower case for easy reference
colnames(diabetes) <- tolower(colnames(diabetes))
```

We will assign factors to categorical variables for ease of interpretation. 

# Create Factors
```{r}
diabetes <- diabetes |>
  mutate(
    diabetes_binary_f = factor(diabetes_binary, levels = c(0,1),
                               labels = c("no diabetes", "diabetes")), 
    highbp_f = factor(highbp, levels = c(0,1),
                               labels = c("no high BP", "high BP")),
    highchol_f = factor(highchol, levels = c(0,1),
                               labels = c("no high cholesterol", "high cholesterol")),
    cholcheck_f = factor(cholcheck, levels = c(0,1),
                               labels = c("no cholesterol check in 5 years", "yes cholesterol check in 5 years")),
    smoker_f = factor(smoker, levels = c(0,1),
                               labels = c("no", "yes")), 
    stroke_f = factor(stroke, levels = c(0,1),
                               labels = c("no", "yes")),
    heartdiseaseorattack_f = factor(heartdiseaseorattack, levels = c(0,1),
                               labels = c("no", "yes")),
    physactivity_f = factor(physactivity, levels = c(0,1),
                               labels = c("no", "yes")),
    fruits_f = factor(fruits, levels = c(0,1),
                               labels = c("no","yes")),
    veggies_f = factor(veggies, levels = c(0,1),
                               labels = c("no", "yes")),
    hvyalcoholconsump_f = factor(hvyalcoholconsump, levels = c(0,1),
                               labels = c("no", "yes")),
    anyhealthcare_f = factor(anyhealthcare, levels = c(0,1),
                               labels = c("no", "yes")),
    nodocbccost_f = factor(nodocbccost, levels = c(0,1),
                               labels = c("no","yes")),
    genhlth_f = factor(genhlth, levels = 1:5,
                               labels = c("excellent", "very good", "good", "fair", "poor")),
    diffwalk_f  = factor(diffwalk, levels = c(0,1),
                               labels = c("no", "yes")),
    sex_f = factor(sex, levels = c(0,1),
                               labels = c("female", "male")),
    age_f = factor(age, levels = 1:13,
                        labels = c("18 to 24",
                          "25 to 29", 
                          "30 to 34", 
                          "35 to 39",
                          "40 to 44",
                          "45 to 49",
                          "50 to 54",
                          "55 to 59",
                          "60 to 64",
                          "65 to 69",
                          "70 to 74",
                          "75 to 79", 
                          "80 to high"
                   )),
    education_f = factor(education, levels = 1:6,
                         labels = c("Never attended school or only kindergarten",
                         "Grades 1 through 8 (Elementary)",
                         "Grades 9 through 11 (Some high school)",
                         "Grade 12 or GED (High school graduate)",
                         "College 1 year to 3 years (Some college or technical school)",
                         "College 4 years or more (College graduate)")
                         ),
    income_f = factor(income, levels = 1:8,
                      labels = c("< 10k",
                                "< 15k",
                                "< 20k",
                                "< 25k",
                                "< 35k",
                                "< 50k",
                                "< 75k",
                                "75k+"))
  )
```

# EDA - Exploratory Data Analysis

## Missing Values

We can see below there are no missing values in our dataset for any variable including new factor variables.

```{r}

# write function to count NAs in a column
sum_na <- function(column) {
  sum(is.na(column))
}

# operate function across all dataset columns
na_counts <- diabetes |>
  summarize(across(everything(), sum_na))
na_counts
```



## Exploring Variables of interest

The first two variables of interest were income and age. One-way, two-way, and grouped bar plots were produced to gather more insight. The frequency distribution plot is immediately the most informative as it shows quickly which age groups and which income bands are the most prevalent in the data set. It is difficult to compare diabetes prevalence among income groups just looking at counts. More meaningful analyses will need to include a rate that can be easily compared across categories. 

### Age and Income
```{r}

#diabetes status by income 
diabetes |>
  group_by(income_f, diabetes_binary_f) |>
  summarize(count = n()) |>
  pivot_wider(names_from = diabetes_binary_f, values_from = count)

#diabetes status by age and income 
diabetes |>
  group_by(age_f, income_f) |>
  summarize(count = n()) |>
  pivot_wider(names_from = income_f, values_from = count)

#distribution of age by income
#evident higher income is more common between middle-age
ggplot(diabetes, aes(x = age_f , fill = income_f)) + 
  geom_bar() +
  labs(title = "Frequency Distribution of Age and Income", x = "Age Category", y = "Observations") +
  theme(plot.title = element_text(hjust = 0.5),
    legend.position = "top", legend.box = "horizontal") +
  scale_fill_discrete(guide = guide_legend(nrow=1))

```

### Diabetes prevalence 

Here a rate of diabetes per 1,000 is calculated to allow for quick determination of what demographic and behavioral risk factors have the highest prevalance of diabetes in our dataset. Apparent in the summaries below is that diabetes is most prevalent in males, aged 70 - 74, with incomes between 0 and 15k, who do not consume alcohol heavily, with high blood pressure (BP). 

```{r}

# diabetes prevalence tables
diabetes |>
  group_by(sex_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000))

diabetes |>
  group_by(income_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000))

diabetes |>
  group_by(hvyalcoholconsump_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000))

diabetes |>
  group_by(age_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000))

# two way contingency table of prevalence by high blood pressure and high cholesterol
diabetes |>
  group_by(highbp_f, highchol_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000)) |>
  pivot_wider(names_from = highchol_f, values_from = PrevalencePer1000)

# two way contingency table of prevalence across mental health and physical health levels
diabetes |>
  group_by(smoker_f, hvyalcoholconsump_f) |>
  summarize(PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  arrange(desc(PrevalencePer1000)) |>
  pivot_wider(names_from = smoker_f, values_from = PrevalencePer1000)



```
 
 It seems counter-intuitive that heavy alcohol use is associated with lower diabetes prevalence so more investigation was done to see how high alcohol usage is distributed among other factors like age and income. The two bar charts below show that heavy alcohol use is more common among lower-aged but higher income groups. The previous analysis showed diabetes is more prevalent in older and lower income groups. Heavy alcohol use may not be a worthwhile variable to include in our predictive models. 
 
```{r}
#view proportion of heavy drinkers by income level, age, and sex
alc_inc_df <- diabetes |>
  group_by(income_f, sex_f) |>
  summarize(PrevalencePer1000 = (sum(hvyalcoholconsump == 1)/n())*1000)

ggplot(alc_inc_df, aes(x = income_f , y = PrevalencePer1000, fill = sex_f)) + 
  geom_bar(stat = "identity") +
  labs(title = "Heavy Drinking Rate by Income and Sex", x = "Income Level", y = "Incidence of Heavy Drinking (per 1000)") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top", legend.box = "horizontal") +
  scale_fill_discrete(guide = guide_legend(nrow=1))

alc_age_df <- diabetes |>
  group_by(age_f, sex_f) |>
  summarize(PrevalencePer1000 = (sum(hvyalcoholconsump == 1)/n())*1000)

ggplot(alc_age_df, aes(x = age_f , y = PrevalencePer1000, fill = sex_f)) + 
  geom_bar(stat = "identity") +
  labs(title = "Heavy Drinking Rate by Age and Sex", x = "Age Level", y = "Incidence of Heavy Drinking (per 1000)") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top", legend.box = "horizontal") +
  scale_fill_discrete(guide = guide_legend(nrow=1))

```


### Mental Health
Next we will investigate if the number of reported "poor mental health days" would be a worthwhile variable to include in the model. We can see that this variable is sparsely populated with values greater than 0 and the diabetes prevalence is not **much** greater among the group with non-zero poor mental health days. 
```{r}
#general numeric summary of the mental health numeric variable - range is 0-30 with many zero responses

ggplot(diabetes, aes(x = menthlth)) +
  geom_density() + 
  labs(title = "Frequency of Poor Mental Health Days", x = "# of Reported Poor Mental Health Days", y = "Relative Frequency") +
  theme(plot.title = element_text(hjust = 0.5))

#create mental health binary and see percentage with a non-zero response
#diabetes is more prevalent 
diabetes |>
  mutate(mentalhealth_flag = if_else(menthlth == 0, "none", "1+")) |>
  group_by(mentalhealth_flag) |>
  summarize(count = n(),
            PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  mutate("Col%" = round((count/253680)*100,2))
```


### BMI
Body-mass index (BMI) is another variable of interest. It has a much more "normal" looking distribution than mental health days and those with BMI values above the median BMI value of 27 have a significantly higher prevalence of diabetes. 

```{r}

#ggplot showing BMI is much more consistently populated throughout the dataset than the mental health variable
ggplot(diabetes, aes(x = bmi)) +
  geom_density() +
  labs(title = "Frequency of BMI Values", x = "BMI", y = "Relative Frequency") +
  theme(plot.title = element_text(hjust = 0.5))

#prevalence per 1000 is more than double for those with BMI above the Median
diabetes |>
  mutate(BMI_flag = if_else(bmi > 27, "Above Median BMI", "Below Median BMI")) |>
  group_by(BMI_flag) |>
  summarize(count = n(),
            PrevalencePer1000 = (sum(diabetes_binary == 1)/n())*1000) |>
  mutate("Col%" = round((count/253680)*100,2))
```

Below is a visual demonstration of the difference in BMI distributions among those with diabetes and those without diabetes. It is clear BMI values do differ between those with and without diabetes in our dataset. 

```{r}
ggplot(diabetes, aes(x = bmi, fill = diabetes_binary_f)) +
  geom_density(alpha = 0.5) +
  labs(title = "Frequency of BMI Values by Diabetes Status", x = "BMI", y = "Relative Frequency") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "top", legend.box = "horizontal") +
  scale_fill_discrete(guide = guide_legend(nrow=1))
```


# Model Variable Selection

The five predictor variables selected for the prediction modeling step are: blood pressure, sex, income, age, and BMI. 

You can find the modeling results here!


